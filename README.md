# Tests API Hotel TV Manager

Проект содержит автотесты API Hotel TV Manager. Используется Python 3.6, Requests.

## Установка:
1. Установить Python 3.x (https://www.python.org/). На данный момент гарантирована работа на версии 3.6.
1. Клонировать репозиторий:
    ```
    git clone git@git.itv.restr.im:qa_b2b/htm_api.git
    ```
1. Перейти в папку проекта
    ```
    cd htm_api/
    ```
1. Установить необходимые библиотеки:
    ```
    pip install --upgrade -r requirements.txt
    ```
## Запуск всех тестов:
1. **ВАЖНО:**
Перед запуском тестов необходимо настроить локальный файл с переменными для тестового окружения .env
    * Пример файла .env (размещается в корне проекта):
        ```
        TARGET_ENV="test"
        MRF="ct"
        ```
    * TARGET_ENV - окружение SDP (test или prod)
    * MRF - мрф, в котором будут проводиться тесты
    * Если файл отсутствует, по умолчанию будет использоваться "test" "ct"
1. Необходимо расшифровать зашифрованные файлы при помощи git-crypt (см. инструкцию ниже)  
1. Находясь в корневой папке проекта выполнить команду: 
    ```
    py.test
    ```
1. Можно запускать тесты с формированием красивых отчетов в allure. Чтобы сделать это, можно просто запустить скрипт
    ```
    ./run_all_tests_with_allure.sh
    ```
    который находится в корневой директории проекта.
    Данный скрипт скачивает и устанавливает allure в определенную директорию (если уже есть в этой директории - то пропускает этот шаг);
    далее он прогоняет все тесты и разворачивает локальный сервер с отчетами allure.
## Настройка git-crypt
* Установить git crypt
    * Для Linux:
        ```
        sudo apt install git-crypt
        ```
    * Для Mac OS X:
        ```
        brew install git-crypt
        ```
    * Для windows см. https://github.com/AGWA/git-crypt (там же документация)
* Получить crypt-key и положить его в папку .git/git-crypt/keys/
* В корневой папке проекта выполнить:
    ```
    git-crypt unlock .git/git-crypt/keys/default
    ```
* Это нужно сделать только один раз - далее вы можете использовать git как обычно, шифрование и дешифрование будет происходят прозрачно.

## Структура проекта:
* **tests** - содержит сами тесты
* **api** - содержит логику работы с API HTM
* **models** - описание основных сущностей системы
* **shared** - содержит константы, а также вспомогательные методы генерации тестовых данных
* **tests_.../conftest.py** - содержит фикстуры для подготовки тестовых данных (для каждого тестового набора - свой)
* **settings.py** - содержит методы для настройки тестового окружения
* **pytest.ini** - содержит настройки логгирования
* **config.yaml** - содержит данные тестового окружения
* **secret_config.yaml** - локальный файл (**обязательный**). Содержит секретные данные (данные авторизации пользователей всех ролей)
* **.env** - локальный файл с переменными окружения.
* **tests_admin_rt** - содержит тесты, выполняемые под сессией администратора Ростелеком
* **tests_admin_hotel** - содержит тесты, выполняемые под сессией администратора гостиницы
* **tests_employee** - содержит тесты, выполняемые под сессией сотрудника
* **tests_no_role** - содержит тесты, для которых не требуется авторизационная сессия, а также тесты проверки на корректность ответа на все остальные запросы

## Логгирование:
* Для включения логгирования необходимо в файле pytest.ini выставить:
    ```
    log_cli = true
    ```
* Уровни логгирования задаются в параметре ```log_cli_level```. Доступные значения:
    * INFO - отображаются информационные логи, предупреждения и ошибки
    * WARNING - отображаются предупреждения и ошибки
    * ERROR - отображаются только ошибки
    * DEBUG - отображаются все логи (включая стандартные в pytest)
